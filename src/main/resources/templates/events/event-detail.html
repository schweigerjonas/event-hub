<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    layout:decorate="~{layout}">
<main layout:fragment="main">
    <div class="container py-4">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
            <div>
                <h1 class="mb-1" th:text="${event.name}">Event</h1>
                <div class="text-muted" th:text="${event.location}">Ort</div>
            </div>
            <a class="btn btn-outline-secondary" th:href="@{/events}">Zurück zur Übersicht</a>
        </div>

        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
        <div th:if="${info}" class="alert alert-info" th:text="${info}"></div>
        <div th:if="${error}" class="alert alert-warning" th:text="${error}"></div>

        <div class="row g-3">
            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Datum</div>
                            <div class="col-sm-8">
                                <span th:if="${event.eventTime != null}" th:text="${#temporals.format(event.eventTime, 'dd.MM.yyyy HH:mm')}"></span>
                                <span th:if="${event.eventTime == null}">Nicht angegeben</span>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Dauer</div>
                            <div class="col-sm-8">
                                <span th:if="${event.durationMinutes != null}" th:text="${event.durationMinutes} + ' min'"></span>
                                <span th:if="${event.durationMinutes == null}">Nicht angegeben</span>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Max. Teilnehmer</div>
                            <div class="col-sm-8">
                                <span th:if="${event.maxParticipants != null}" th:text="${event.maxParticipants}"></span>
                                <span th:if="${event.maxParticipants == null}">Nicht angegeben</span>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Kosten</div>
                            <div class="col-sm-8">
                                <span th:if="${event.costs > 0}" th:text="${#numbers.formatDecimal(event.costs, 1, 2)} + ' EUR'"></span>
                                <span th:if="${event.costs <= 0}">Kostenlos</span>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-sm-4 text-muted">Organisator</div>
                            <div class="col-sm-8" th:text="${event.organizer != null ? event.organizer.username : 'Unbekannt'}"></div>
                        </div>

                        <div>
                            <h5>Beschreibung</h5>
                            <p th:if="${event.description != null && !event.description.isBlank()}" th:text="${event.description}"></p>
                            <p class="text-muted" th:if="${event.description == null || event.description.isBlank()}">Keine Beschreibung vorhanden.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Aktionen</h5>
                        <div sec:authorize="isAuthenticated()">
                            <div th:if="${isOrganizer}">
                                <form th:action="@{'/events/' + ${event.id} + '/cancel'}" method="post">
                                    <button class="btn btn-outline-danger w-100" type="submit">Event absagen</button>
                                </form>
                            </div>
                            <div th:if="${!isOrganizer}">
                                <form th:if="${isParticipant}" th:action="@{'/events/' + ${event.id} + '/leave'}" method="post">
                                    <button class="btn btn-outline-danger w-100" type="submit">Abmelden</button>
                                </form>
                                <form th:if="${!isParticipant}" th:action="@{'/events/' + ${event.id} + '/join'}" method="post">
                                    <button class="btn btn-primary w-100" type="submit">Teilnehmen</button>
                                </form>
                            </div>
                            <div th:if="${isParticipant}">
                                <button class="btn btn-outline-primary w-100 mt-2" type="button"
                                    data-bs-toggle="modal" data-bs-target="#invite-modal"
                                    th:disabled="${#lists.isEmpty(friends)}">
                                    Freunde einladen
                                </button>
                                <div class="text-muted small mt-1" th:if="${#lists.isEmpty(friends)}">Keine Freunde verfügbar.</div>
                            </div>
                        </div>
                        <div sec:authorize="!isAuthenticated()">
                            <form th:action="@{'/events/' + ${event.id} + '/join'}" method="post">
                                <button class="btn btn-primary w-100" type="submit">Teilnehmen</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4" sec:authorize="isAuthenticated()">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Teilnehmerliste</h5>
                        <div class="text-muted small" th:text="${participantsTotalItems} + ' Teilnehmer'"></div>
                    </div>
                    <div th:if="${#lists.isEmpty(participants)}" class="text-muted">Noch keine Teilnehmer.</div>
                    <ul class="list-group" th:if="${!#lists.isEmpty(participants)}">
                        <li class="list-group-item d-flex justify-content-between align-items-center"
                            th:each="participant : ${participants}">
                            <div class="d-flex align-items-center gap-2">
                                <span th:text="${participant.user.username}">Username</span>
                                <span class="badge bg-secondary" th:if="${participant.organizer}">Organisator</span>
                            </div>
                        </li>
                    </ul>
                    <nav aria-label="Teilnehmer Pagination" class="mt-3" th:if="${participantsTotalPages > 1}">
                        <ul class="pagination mb-0">
                            <li class="page-item" th:classappend="${participantsPage == 1} ? 'disabled'">
                                <a class="page-link"
                                   th:href="@{/events/{id}(id=${event.id}, participantsPage=1, participantsSize=${participantsSize})}"><<</a>
                            </li>
                            <li class="page-item" th:classappend="${participantsPage == 1} ? 'disabled'">
                                <a class="page-link"
                                   th:href="@{/events/{id}(id=${event.id}, participantsPage=${participantsPage - 1}, participantsSize=${participantsSize})}">Zurück</a>
                            </li>
                            <li class="page-item" th:each="page : ${#numbers.sequence(participantsPage > 2 ? participantsPage - 2 : 1, participantsPage + 2 < participantsTotalPages ? participantsPage + 2 : participantsTotalPages)}"
                                th:classappend="${page == participantsPage} ? 'active'">
                                <a class="page-link"
                                   th:href="@{/events/{id}(id=${event.id}, participantsPage=${page}, participantsSize=${participantsSize})}"
                                   th:text="${page}">1</a>
                            </li>
                            <li class="page-item" th:classappend="${participantsPage == participantsTotalPages} ? 'disabled'">
                                <a class="page-link"
                                   th:href="@{/events/{id}(id=${event.id}, participantsPage=${participantsPage + 1}, participantsSize=${participantsSize})}">Weiter</a>
                            </li>
                            <li class="page-item" th:classappend="${participantsPage == participantsTotalPages} ? 'disabled'">
                                <a class="page-link"
                                   th:href="@{/events/{id}(id=${event.id}, participantsPage=${participantsTotalPages}, participantsSize=${participantsSize})}">>></a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="invite-modal" tabindex="-1" aria-hidden="true" sec:authorize="isAuthenticated()" th:if="${isParticipant}">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Freunde einladen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
                </div>
                <form th:action="@{'/events/' + ${event.id} + '/invite'}" method="post">
                    <div class="modal-body">
                        <div th:if="${#lists.isEmpty(friends)}" class="text-muted">Keine Freunde verfügbar.</div>
                        <div class="list-group" th:if="${!#lists.isEmpty(friends)}">
                            <label class="list-group-item d-flex align-items-center gap-2"
                                th:each="friend : ${friends}">
                                <input class="form-check-input m-0" type="checkbox" name="friendIds"
                                    th:value="${friend.id}">
                                <span th:text="${friend.username}">Freund</span>
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Abbrechen</button>
                        <button type="submit" class="btn btn-primary" th:disabled="${#lists.isEmpty(friends)}">Einladung absenden</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</main>
</html>
